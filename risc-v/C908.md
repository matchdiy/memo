# C908 学习笔记

[玄铁C908R1S0用户手册(xrvm)](./resource/C908R1S0.pdf)

## 第一章

C908MP 是基于 RISC-V 指令架构的 64 位高性能多核心处理器，主要面向 IoT 市场日益增强的图像、 视觉处理领域，例如智慧视觉、车载视觉、行车记录仪、智能交互等。其他应用领域还包括扫地机器人、无 人机、自动化驾驶、增强现实、医疗图像、机器人工业视觉、移动互联网等产品。

C908MP 采用同构多核架构，支持多 cluster，每个 cluster 支持 1~4 个核心。每个 C908 核心采用自主 设计的微体系结构，并重点针对性能进行优化，采用按序双发射、多模式分支预测和多通道数据预取等高性 能技术。此外，C908 核心支持实时检测并关断内部空闲功能模块，降低处理器动态功耗。


### C908MP 处理器体系结构的主要特点

- 同构多核架构，支持多 cluster，每个 cluster 支持 1~4 个 C908 核心；
- 支持 1 个 AXI4.0 或 ACE Master 接口，128 比特的总线宽度；
- 支持 1 个可配置的 AXI4.0 低延时外设 Master 接口 (Low Latency Port, LLP)，128 比特的总线宽度；
- 支持 1 个可配的 AXI4.0 设备一致性接口 (Device Coherence Port, DCP)，128 比特的总线宽度；
- 一级指令/数据缓存分别支持 16KB/32KB/64KB，缓存行 SIZE 为 64B；可配置 ECC/奇偶校验机制；
- 二级高缓 128KB/256KB/512KB/1MB/1.5MB/2MB/3MB/4MB，缓存行 SIZE 为 64B；可配置 ECC 校验机制；
- 一级缓存支持 MESI 一致性协议，二级缓存支持 MOESI 一致性协议；
- 支持私有中断控制器 CLINT 和公有中断控制器 PLIC；支持多 cluster 中断分发；
- 支持 RISC-V 性能计数器和计时器；
- 支持 Sv39 和 Sv48 内存管理，支持 SVNAPOT 和 SVPBMT 标准扩展；
- 支持 8/16/32/64 表项 PMP，支持 ePMP；
- 支持 XuanTie TEE 扩展；
- 支持各个核心独立下电以及 cluster 下电；
- 支持 RISC-V 调试框架，支持多核多 cluster 调试；


### C908 核心的主要特点
- RISC-V 64GCB[V] 指令架构；
- User Mode 支持 RV64 和 RV32 指令集；
- 支持小端模式；
- 9 级流水架构；
- 按序双发射，按序取指、发射、执行和退休；
- 两级 TLB 内存管理单元，实现虚实地址转换与内存管理；
- 指令高缓和数据高缓大小可配置，支持 16KB/32KB/64KB，缓存行为 64B；
- 指令高缓可配置奇偶校验，数据高缓可配置 ECC 或奇偶校验；
- 指令预取功能，硬件自动检测并动态启动；
- 指令高缓路预测的低功耗访问技术；
- 支持 2KB/4KB/8KB 的多算法分支预测器；
- 支持 256 表项的分支目标缓存器 (BTB)；
- 支持 8 层的硬件返回地址堆栈；
- 支持 256 表项的间接跳转分支预测器；
- 支持循环终止预测；
- 支持指令融合技术；
- 双发射按序执行 Load、Store 指令；
- 读、写内存分别支持 8 路、12 路并发的总线访问；
- 支持写合并；
- 支持 8 通道数据预取，支持固定 stride 和规律性不定 stride 数据预取；


### 矢量计算单元的主要特点

- 遵循 RISC-V V 矢量扩展；
- 在 4 核、2GHz 最大配置下，算力可达 512 Gops (@int8) / 256 GFlops (@FP16)；
- 矢量执行单元支持 FP16/BFP16/FP32 浮点和 INT8/INT16/INT32/INT64 整型的矢量运算；
- 支持 128/256 可配置的矢量寄存器位宽 VLEN；
- 支持矢量执行单元运算和数据存储流水线数量 (1 或 2) 可配；
- 支持 128 位或 256 位 矢量数据存储访问位宽；
- 支持 segment load、store 指令；
- 性能优化的 非对齐内存访问；


### C908 兼容于玄铁 C 系列 1.0 扩展架构，具体包括:

- 运算指令扩展：在整型、浮点、load/store 等方面提高运算能力，是 RISC-V 基础指令集的有力补充。
- Cache 操作扩展：方便地进行 Cache 维护操作，提高 Cache 效率。
- 内存模型扩展：高效管理地址属性，提高内存访问效率。
- 控制寄存器扩展：在标准 RISC-V 的基础上提供更加丰富的功能。
- 多核同步指令扩展：提高多核一致性维护的效率。


### C908MP可配置选项

| 功能                | 配置选项                             | 详细描述                                                                 |
|---------------------|--------------------------------------|-------------------------------------------------------------------------|
| **C908 Cluster**    |                                      |                                                                         |
| 核心数量            | 1/2/3/4                             | C908MP 提供 1-4 个 C908 核心可配                                       |
| 浮点单元            | 有/无                               | 浮点运算单元可配                                                       |
| **VECTOR_SIMD**     | 有/无                               | 矢量执行单元可配，配置浮点单元是配置矢量执行单元的前提                 |
| 矢量寄存器位宽      | 128/256                             | VLEN128/VLEN256 可配。<br>注意：VLEN128 固定搭配 DP 64，VLEN256 固定搭 DP128 |
| 双倍矢量执行单元    | 有/无                               | 是否配置两套矢量运算流水线和存储访问流水线                             |
| **BHT**             | Pro/Lite                            | BHT 实现方式：Pro（tage）或 Lite（gshare）                              |
| **MMU**             | SV39/SV48                           | 支持 SV39 或 SV48 模式，配置为 SV48 可以同时支持 SV39                   |
| jTLB entry          | 512/1024                            | jTLB 表项数                                                             |
| Master 接口协议     | AXI/ACE                             | Master 接口支持 AXI 或 ACE 协议                                         |
| LLP                 | 有/无                               | 低延时外设端口可选                                                     |
| DCP                 | 有/无                               | 用于外设对片上高速缓存的访问，实现数据一致性，可用于连接 DMA            |
| L1 I-Cache          | 16K/32K/64K                         | 可以配置 16KB、32KB、64KB                                              |
| L1 D-Cache          | 16K/32K/64K                         | 可以配置 16KB、32KB、64KB                                              |
| L1 ECC/Parity       | 有/无                               | L1 I-Cache 的 Parity 校验、L1 D-Cache 的 ECC 校验                       |
| L2 Cache            | 128K/256K/512K/1M/1.5M/2M/3M/4M     | 可以配置 128KB~4MB                                                     |
| L2 ECC              | 有/无                               | L2 Tag/Data RAM 的 ECC 校验                                            |
| PMP 区域个数        | 8/16/32/64                          | PMP 区域个数可配                                                       |
| EPMP                | 有/无                               | Enhanced PMP 功能可配置                                                |
| TEE                 | 有/无                               | TEE 扩展可选                                                           |
| L2 RAM 延时         | 可配置                              | 支持配置 Tag RAM 和 Data RAM 的 Setup 和 Access 周期                   |
| 调试资源级别        | 最小/典型/最大                      | 推荐“典型”配置                                                        |
| System Bus Access   | 无/有                               | 可以配置单独的 AXI 总线接口, 用于调试器绕过 CPU 独立访问内存空间       |
| pic_top 中断数量     | 32-1024，step 32                   | PLIC 支持的可接入中断数量，范围为 32-1024，且需设置为 32 的倍数         |
| APB 端口数量        | 1-32                                | tdt_dmi_top 调试多个 Cluster，一个 APB 端口对应一个 Cluster             |

**注释**：
- FPU 固定包含，所以不是可配选项。
- Cluster 和 pic_top 的 TEE 选项必须保持一致。
- 调试资源级别：
  - 最小配置：1 个 trigger，可配置为指令地址类型，支持全等匹配、低位掩码匹配。
  - 典型配置：3 个 trigger，每个 trigger 可配置为指令地址类型、访存地址类型，支持全等匹配、低位掩码匹配。
  - 最大配置：8 个 trigger，每个 trigger 可配置为指令地址类型、访存地址类型等，支持复杂匹配模式。

